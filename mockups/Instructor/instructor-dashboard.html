<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Riya's Dashboard | Dive Dispatch</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#1978e5",
              "background-light": "#f6f7f8",
              "background-dark": "#111821",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      body {
        font-family: "Inter", sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .nav-link {
        @apply text-[11px] font-semibold uppercase tracking-widest text-slate-500 dark:text-slate-400 hover:text-primary dark:hover:text-primary transition-colors;
      }
      .nav-link.active {
        @apply text-primary;
      }

      .date-num {
        @apply w-7 h-7 flex items-center justify-center rounded-full text-sm font-medium text-slate-500 dark:text-slate-400;
      }
      .date-num.today {
        @apply bg-primary text-white font-bold;
      }

      .bk-bar {
        @apply absolute text-[9px] leading-tight rounded px-1.5 py-1 cursor-pointer hover:opacity-80 transition-opacity no-underline border border-black;
      }
      .diver-line {
        @apply flex items-baseline justify-between gap-1;
      }
      .diver-name {
        @apply font-medium truncate;
      }
      .diver-abbrev {
        @apply font-bold flex-shrink-0;
      }
      .bk-bar.draft {
        @apply bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400;
      }
      .bk-bar.pending {
        @apply bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400;
      }
      .bk-bar.active {
        @apply bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400;
      }
      .bk-bar.completed {
        @apply bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400;
      }

      .state-badge {
        @apply inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold flex-shrink-0;
      }
      .state-badge.draft {
        @apply bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400;
      }

      .widget-card {
        @apply bg-white dark:bg-slate-900/40 rounded-xl border border-slate-100 dark:border-slate-800 p-5;
      }
      .widget-title {
        @apply text-[10px] font-bold uppercase tracking-[0.2em] text-slate-400 mb-4;
      }

      .user-panel {
        @apply absolute top-full right-0 mt-2 w-44 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl shadow-xl z-50 py-1.5 hidden;
      }
      .user-panel.open {
        @apply block;
      }
      .user-item {
        @apply flex items-center gap-3 px-4 py-2.5 text-[11px] font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 hover:text-primary transition-colors cursor-pointer;
      }
    </style>
  </head>

  <body
    class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-display min-h-screen selection:bg-primary/20"
  >
    <!-- ── Top Nav ──────────────────────────────────────────────────── -->
    <nav
      class="sticky top-0 z-40 bg-white dark:bg-slate-900/60 border-b border-slate-200 dark:border-slate-900 backdrop-blur-sm"
    >
      <div class="px-8 h-16 flex items-center">
        <!-- Left: Back button -->
        <div class="flex-1">
          <a
            href="../Shared/landing.html"
            class="flex items-center gap-1 text-slate-400 hover:text-primary transition-colors no-underline w-fit"
          >
            <span class="material-symbols-outlined text-[20px]">arrow_back</span>
            <span class="text-[11px] font-semibold uppercase tracking-widest">Back</span>
          </a>
        </div>

        <!-- Centre: page title -->
        <span class="text-sm font-semibold text-slate-800 dark:text-white tracking-tight">
          Riya's Dashboard
        </span>

        <!-- Right: language toggle + theme toggle + user -->
        <div class="flex-1 flex items-center justify-end gap-3">
          <!-- Language toggle -->
          <div
            class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-full p-0.5 gap-0.5"
          >
            <button
              id="lang-en"
              onclick="setLang('en')"
              class="lang-pill px-3 py-1 rounded-full text-[11px] font-bold uppercase tracking-widest bg-primary text-white transition-all"
            >
              EN
            </button>
            <button
              id="lang-th"
              onclick="setLang('th')"
              class="lang-pill px-3 py-1 rounded-full text-[11px] font-bold uppercase tracking-widest text-slate-400 dark:text-slate-500 hover:text-slate-600 transition-all"
            >
              TH
            </button>
          </div>

          <!-- Dark mode toggle -->
          <button
            id="darkToggle"
            class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
            title="Toggle dark mode"
          >
            <span class="material-symbols-outlined text-[18px]">dark_mode</span>
          </button>

          <!-- User menu -->
          <div class="relative" id="user-wrap">
            <button
              onclick="toggleUser(event)"
              class="flex items-center gap-2 hover:opacity-80 transition-opacity ml-1"
            >
              <div
                class="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-white text-[10px] font-bold flex-shrink-0"
              >
                R
              </div>
              <span
                class="hidden md:block text-[11px] font-semibold uppercase tracking-widest text-slate-700 dark:text-slate-300"
              >
                Riya
              </span>
              <span
                class="material-symbols-outlined text-slate-400 text-[14px] hidden md:block"
                >expand_more</span
              >
            </button>
            <div class="user-panel" id="user-panel">
              <a class="user-item" href="#">
                <span class="material-symbols-outlined text-[16px]"
                  >settings</span
                >
                Settings
              </a>
              <div
                class="my-1 border-t border-slate-100 dark:border-slate-800"
              ></div>
              <a class="user-item hover:text-red-500" href="../Shared/landing.html">
                <span class="material-symbols-outlined text-[16px]"
                  >logout</span
                >
                Sign Out
              </a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- ── Page Content ───────────────────────────────────────────── -->
    <main class="px-8 py-8 max-w-screen-xl mx-auto">
      <!-- Calendar + Widgets -->
      <div>

        <!-- ── Top widget (boilerplate placeholder) ──────────────────── -->
        <div class="widget-card mb-6 min-h-[80px]"></div>

        <div
            class="bg-white dark:bg-slate-900/40 rounded-xl border border-slate-100 dark:border-slate-800 shadow-sm overflow-hidden"
          >
            <!-- Calendar header -->
            <div
              class="flex items-center px-5 py-4 border-b border-slate-100 dark:border-slate-800"
            >
              <div class="flex-1">
                <button
                  class="text-[10px] font-bold uppercase tracking-widest text-slate-400 hover:text-primary px-3 py-1.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border border-slate-200 dark:border-slate-700"
                >
                  Today
                </button>
              </div>
              <div class="flex items-center gap-2">
                <button
                  class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                >
                  <span class="material-symbols-outlined text-lg">chevron_left</span>
                </button>
                <h2
                  class="text-sm font-semibold text-slate-800 dark:text-white w-36 text-center"
                >
                  February 2026
                </h2>
                <button
                  class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-primary hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
                >
                  <span class="material-symbols-outlined text-lg">chevron_right</span>
                </button>
              </div>
              <div class="flex-1 flex justify-end">
                <button
                  class="text-[10px] font-bold uppercase tracking-widest text-slate-400 hover:text-primary px-3 py-1.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border border-slate-200 dark:border-slate-700"
                >
                  This Week
                </button>
              </div>
            </div>

            <!-- Day-of-week headers -->
            <div
              class="grid grid-cols-7 border-b border-slate-100 dark:border-slate-800"
            >
              <div class="py-3 text-center text-[10px] font-bold uppercase tracking-widest text-slate-400">Sun</div>
              <div class="py-3 text-center text-[10px] font-bold uppercase tracking-widest text-slate-400">Mon</div>
              <div class="py-3 text-center text-[10px] font-bold uppercase tracking-widest text-slate-400">Tue</div>
              <div class="py-3 text-center text-[10px] font-bold uppercase tracking-widest text-slate-400">Wed</div>
              <div class="py-3 text-center text-[10px] font-bold uppercase tracking-widest text-slate-400">Thu</div>
              <div class="py-3 text-center text-[10px] font-bold uppercase tracking-widest text-slate-400">Fri</div>
              <div class="py-3 text-center text-[10px] font-bold uppercase tracking-widest text-slate-400">Sat</div>
            </div>

            <!-- Calendar grid — February 2026 -->
            <div class="divide-y divide-slate-100 dark:divide-slate-800">
              <!-- Week 1: Feb 1–7 -->
              <div>
                <div class="grid grid-cols-7 divide-x divide-slate-100 dark:divide-slate-800">
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">1</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">2</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">3</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">4</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">5</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">6</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">7</span></div>
                </div>
                <div id="week-1-events"></div>
              </div>

              <!-- Week 2: Feb 8–14 -->
              <div>
                <div class="grid grid-cols-7 divide-x divide-slate-100 dark:divide-slate-800">
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">8</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">9</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">10</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">11</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">12</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">13</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">14</span></div>
                </div>
                <div id="week-2-events"></div>
              </div>

              <!-- Week 3: Feb 15–21 (TODAY = Feb 15) -->
              <div>
                <div class="grid grid-cols-7 divide-x divide-slate-100 dark:divide-slate-800">
                  <div class="px-2 pt-2 pb-1 flex justify-end bg-blue-50/60 dark:bg-blue-950/20">
                    <span class="date-num today">15</span>
                  </div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">16</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">17</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">18</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">19</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">20</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">21</span></div>
                </div>
                <div id="week-3-events"></div>
              </div>

              <!-- Week 4: Feb 22–28 -->
              <div>
                <div class="grid grid-cols-7 divide-x divide-slate-100 dark:divide-slate-800">
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">22</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">23</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">24</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">25</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">26</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">27</span></div>
                  <div class="px-2 pt-2 pb-1 flex justify-end"><span class="date-num">28</span></div>
                </div>
                <div id="week-4-events"></div>
              </div>
            </div>

            <!-- Legend -->
            <div
              class="px-5 py-3 border-t border-slate-100 dark:border-slate-800 flex items-center gap-5 flex-wrap"
            >
              <span class="text-[9px] font-bold uppercase tracking-widest text-slate-300 dark:text-slate-600">Status</span>
              <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-slate-300 dark:bg-slate-600 flex-shrink-0"></span>
                <span class="text-[10px] text-slate-400">Draft</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-amber-400 flex-shrink-0"></span>
                <span class="text-[10px] text-slate-400">Pending</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-green-500 flex-shrink-0"></span>
                <span class="text-[10px] text-slate-400">Active</span>
              </div>
              <div class="flex items-center gap-1.5">
                <span class="w-2 h-2 rounded-full bg-primary flex-shrink-0"></span>
                <span class="text-[10px] text-slate-400">Completed</span>
              </div>
            </div>
          </div>
        <!-- ── Widgets row ──────────────────────────────────────────── -->
        <div class="flex gap-6 mt-6 items-start">

          <!-- Pending Requests widget -->
          <div class="widget-card flex-1">
            <p class="widget-title">Open Requests</p>

            <div id="open-requests-list" class="space-y-3"></div>
          </div>

          <!-- Manage Availability link card -->
          <div class="widget-card flex-1">
            <a
              href="../Shared/Availability/instructor-availability.html"
              class="flex items-center gap-3 group no-underline"
            >
              <div
                class="w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0"
              >
                <span
                  class="material-symbols-outlined text-primary text-[18px]"
                  >calendar_month</span
                >
              </div>
              <div>
                <p
                  class="text-[11px] font-bold uppercase tracking-widest text-slate-700 dark:text-slate-300 group-hover:text-primary transition-colors"
                >
                  Manage Availability
                </p>
                <p class="text-[10px] text-slate-400 mt-0.5">
                  Block or open dates
                </p>
              </div>
              <span
                class="material-symbols-outlined text-slate-300 dark:text-slate-600 text-[16px] ml-auto group-hover:text-primary transition-colors"
                >chevron_right</span
              >
            </a>
          </div>

        </div>
        <!-- end widgets row -->
      </div>
    </main>

    <!-- ── Course duration rules (inlined) ── -->
    <script>
      const COURSE_DURATIONS = { OW: 3, AOW: 2, "O+A": 4, "AOW+FD": 3, FD: 1, TD: 1 };
      const COURSE_LABELS = { OW: "Open Water", AOW: "Adv. Open Water", "O+A": "OW + AOW", "AOW+FD": "AOW + Fun Dive", FD: "Fun Dive", TD: "Try Dive" };
      function colsFor(courseType, startCol) {
        const duration = COURSE_DURATIONS[courseType] ?? 1;
        const end = Math.min(startCol + duration, 7);
        return Array.from({ length: end - startCol }, (_, i) => startCol + i);
      }
      function withCols(rawBookings) {
        return rawBookings.map(function (b) {
          return Object.assign({}, b, { cols: colsFor(b.courseType, b.startCol) });
        });
      }
    </script>

    <!-- ── Greedy Skyline Packing Algorithm ── -->
    <script>
      const COL_POSITIONS = [
        { left: "2px" },
        { left: "calc(14.286% + 2px)" },
        { left: "calc(28.571% + 2px)" },
        { left: "calc(42.857% + 2px)" },
        { left: "calc(57.143% + 2px)" },
        { left: "calc(71.429% + 2px)" },
        { left: "calc(85.714% + 2px)" },
      ];
      const COL_WIDTHS = {
        1: "calc(14.286% - 4px)",
        2: "calc(28.571% - 4px)",
        3: "calc(42.857% - 4px)",
        4: "calc(57.143% - 4px)",
        5: "calc(71.429% - 4px)",
        6: "calc(85.714% - 4px)",
        7: "calc(100% - 4px)",
      };
      const DIVER_HEIGHT = 12;
      const PADDING = 10;
      const GAP = 2;

      function bookingHeight(diverCount) {
        return diverCount * DIVER_HEIGHT + PADDING + GAP;
      }

      function pack(bookings) {
        const skyline = [0, 0, 0, 0, 0, 0, 0];
        const placed = [];
        const remaining = bookings.map((b, i) => ({ ...b, idx: i }));

        while (remaining.length > 0) {
          for (const b of remaining) {
            b.ey = Math.max(...b.cols.map((c) => skyline[c]));
          }
          remaining.sort((a, b) => {
            if (a.ey !== b.ey) return a.ey - b.ey;
            if (a.cols.length !== b.cols.length)
              return a.cols.length - b.cols.length;
            const ha = bookingHeight(a.divers.length);
            const hb = bookingHeight(b.divers.length);
            if (ha !== hb) return ha - hb;
            const ca =
              a.cols.reduce((s, c) => s + Math.abs(c - 3), 0) / a.cols.length;
            const cb =
              b.cols.reduce((s, c) => s + Math.abs(c - 3), 0) / b.cols.length;
            return ca - cb;
          });
          const best = remaining.shift();
          const h = bookingHeight(best.divers.length);
          best.y = best.ey;
          for (const c of best.cols) {
            skyline[c] = best.y + h;
          }
          placed.push(best);
        }
        return { placed, height: Math.max(...skyline) };
      }

      function toHTML(placed, height) {
        placed.sort((a, b) => a.y - b.y || a.cols[0] - b.cols[0]);
        let html = `<div class="relative w-full" style="height: ${height}px;">`;
        for (const b of placed) {
          const left = COL_POSITIONS[b.cols[0]].left;
          const width = COL_WIDTHS[b.cols.length];
          html += `<a href="#" class="bk-bar ${b.status}" style="left:${left}; width:${width}; top:${b.y}px;">`;
          for (const d of b.divers) {
            html += `<div class="diver-line"><span class="diver-name">${d.name}</span><span class="diver-abbrev">${d.abbrev}</span></div>`;
          }
          html += `</a>`;
        }
        html += `</div>`;
        return html;
      }

      // ─── Riya's Calendar Data ────────────────────────────────────
      // Bookings are defined with { courseType, startCol } so spans are
      // derived automatically via colsFor() from course-utils.js.
      // withCols() resolves each entry to { cols, ... } before packing.

      // Week 1: Feb 1–7 — 2 completed bookings
      // OW  startCol=1 → cols [1,2,3]  Mon–Wed Feb 2–4   (3 days ✓)
      // AOW startCol=4 → cols [4,5]    Thu–Fri Feb 5–6   (2 days ✓)
      const week1raw = [
        {
          courseType: "OW", startCol: 1, status: "completed",
          divers: [
            { name: "Pranee S.", abbrev: "OW" },
            { name: "Kiri D.", abbrev: "OW" },
          ],
        },
        {
          courseType: "AOW", startCol: 4, status: "completed",
          divers: [
            { name: "Thana N.", abbrev: "AOW" },
            { name: "Bua W.", abbrev: "AOW" },
            { name: "Dao M.", abbrev: "AOW" },
          ],
        },
      ];

      // Week 2: Feb 8–14 — 2 completed
      // FD  startCol=1 → cols [1]      Mon Feb 9          (1 day ✓)
      // OW  startCol=4 → cols [4,5,6]  Thu–Sat Feb 12–14  (3 days ✓) ← completed (was active)
      const week2raw = [
        {
          courseType: "FD", startCol: 1, status: "completed",
          divers: [
            { name: "John K.", abbrev: "FD" },
            { name: "Sara L.", abbrev: "FD" },
          ],
        },
        {
          courseType: "OW", startCol: 4, status: "completed",
          divers: [
            { name: "Marco F.", abbrev: "OW" },
            { name: "Lucia R.", abbrev: "OW" },
            { name: "Amit S.", abbrev: "OW" },
          ],
        },
      ];

      // Week 3: Feb 15–21 — 1 active, 1 draft, 2 pending
      // AOW startCol=0 → cols [0,1]    Sun–Mon Feb 15–16  (2 days ✓) active
      // FD  startCol=2 → cols [2]      Tue Feb 17          (1 day ✓) draft → Open Requests (replaces AOW Feb 16–17 draft)
      // OW  startCol=3 → cols [3,4,5]  Wed–Fri Feb 18–20  (3 days ✓) pending (was active)
      // TD  startCol=6 → cols [6]      Sat Feb 21          (1 day ✓) pending · 1 diver
      // NOTE: AOW Feb 20–21 draft removed entirely
      const week3raw = [
        {
          courseType: "AOW", startCol: 0, status: "active",
          divers: [
            { name: "Valentina C.", abbrev: "AOW" },
            { name: "Sofia E.", abbrev: "AOW" },
          ],
        },
        {
          courseType: "FD", startCol: 2, status: "draft",
          divecenter: "Matt & Ms. Mermaid's Dive Center",
          detailUrl: "instructor-request.html",
          divers: [
            { name: "Patel R.", abbrev: "FD" },
            { name: "Nguyen T.", abbrev: "FD" },
          ],
        },
        {
          courseType: "OW", startCol: 3, status: "pending",
          divers: [
            { name: "Tanaka H.", abbrev: "OW" },
            { name: "Kim J.", abbrev: "OW" },
          ],
        },
        {
          courseType: "TD", startCol: 6, status: "pending",
          divers: [
            { name: "Garcia M.", abbrev: "TD" },
          ],
        },
      ];

      // Week 4: Feb 22–28 — 3 pending (TD) + 1 draft (FD)
      // TD  startCol=0 → cols [0]  Sun Feb 22  (1 day ✓) pending · 3 divers
      // TD  startCol=2 → cols [2]  Tue Feb 24  (1 day ✓) pending · 2 divers
      // FD  startCol=3 → cols [3]  Wed Feb 25  (1 day ✓) draft  → Open Requests
      const week4raw = [
        {
          courseType: "TD", startCol: 0, status: "pending",
          divers: [
            { name: "Chen W.", abbrev: "TD" },
            { name: "Park S.", abbrev: "TD" },
            { name: "Sato K.", abbrev: "TD" },
          ],
        },
        {
          courseType: "TD", startCol: 2, status: "pending",
          divers: [
            { name: "Smith J.", abbrev: "TD" },
            { name: "Lee C.", abbrev: "TD" },
          ],
        },
        {
          courseType: "FD", startCol: 3, status: "draft",
          divecenter: "Similan Dive Center",
          divers: [
            { name: "Rodriguez M.", abbrev: "FD" },
            { name: "Torres L.", abbrev: "FD" },
            { name: "Silva A.", abbrev: "FD" },
            { name: "Kim D.", abbrev: "FD" },
          ],
        },
      ];

      // Week 5: Mar 1–2 — 1 draft request (overflows into March)
      // AOW startCol=0 → cols [0,1]  Sun–Mon Mar 1–2  (2 days ✓) draft
      const week5raw = [
        {
          courseType: "AOW", startCol: 0, status: "draft",
          divecenter: "Matt & Ms. Mermaid's Dive Center",
          detailUrl: "instructor-request.html",
          divers: [
            { name: "Joe Smith", abbrev: "AOW" },
            { name: "Jane Smith", abbrev: "AOW" },
          ],
        },
      ];

      // ─── allWeeks: shared data source for calendar + sidebar ─────
      const allWeeks = [
        { data: week1raw, id: "week-1-events", startDate: 1,  month: "Feb" },
        { data: week2raw, id: "week-2-events", startDate: 8,  month: "Feb" },
        { data: week3raw, id: "week-3-events", startDate: 15, month: "Feb" },
        { data: week4raw, id: "week-4-events", startDate: 22, month: "Feb" },
        { data: week5raw, id: "week-5-events", startDate: 1,  month: "Mar" },
      ];

      function escapeHtml(str) {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function renderSidebar(weeks) {
        const listEl = document.getElementById("open-requests-list");
        if (!listEl) return;
        const drafts = [];
        weeks.forEach(function (w) {
          w.data.forEach(function (b) {
            if (b.status !== "draft") return;
            const duration = COURSE_DURATIONS[b.courseType] || 1;
            const startDay = w.startDate + b.startCol;
            const endDay = startDay + duration - 1;
            const mo = w.month || "Feb";
            const dateStr =
              duration === 1
                ? mo + " " + startDay
                : mo + " " + startDay + "\u2013" + endDay;
            drafts.push(Object.assign({}, b, { dateStr: dateStr }));
          });
        });
        if (drafts.length === 0) {
          listEl.innerHTML =
            '<p class="text-[10px] text-slate-400 text-center py-2">No open requests</p>';
          return;
        }
        listEl.innerHTML = drafts
          .map(function (b) {
            const label = COURSE_LABELS[b.courseType] || b.courseType;
            const count = b.divers.length;
            const center = escapeHtml(b.divecenter || "Unknown Dive Center");
            const url = b.detailUrl || "#";
            const diverWord = count === 1 ? "diver" : "divers";
            return (
              '<div class="rounded-lg border border-slate-100 dark:border-slate-800 p-3">' +
              '<p class="text-[9px] font-bold uppercase tracking-widest text-slate-400 mb-1">' +
              center +
              "</p>" +
              '<p class="text-sm font-medium text-slate-800 dark:text-slate-200 mb-1">' +
              b.dateStr +
              " \u2014 " +
              label +
              " \u00b7 " +
              count +
              " " +
              diverWord +
              "</p>" +
              '<div class="flex items-center gap-2 mt-2">' +
              '<span class="state-badge draft flex-shrink-0">Draft</span>' +
              '<a href="' +
              url +
              '" class="flex-1 text-center text-[10px] font-bold uppercase tracking-wider text-primary hover:text-primary/80 transition-colors no-underline">View Details</a>' +
              '<div class="flex items-center gap-1 flex-shrink-0">' +
              '<button class="w-6 h-6 flex items-center justify-center rounded-full text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Decline">' +
              '<span class="material-symbols-outlined text-[16px]">close</span>' +
              "</button>" +
              '<button class="w-6 h-6 flex items-center justify-center rounded-full text-green-500 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 transition-colors" title="Accept">' +
              '<span class="material-symbols-outlined text-[16px]">check</span>' +
              "</button>" +
              "</div>" +
              "</div>" +
              "</div>"
            );
          })
          .join("");
      }

      document.addEventListener("DOMContentLoaded", function () {
        for (const w of allWeeks) {
          const el = document.getElementById(w.id);
          if (!el) continue;
          const { placed, height } = pack(withCols(w.data));
          el.innerHTML = toHTML(placed, height);
        }
        renderSidebar(allWeeks);
      });
    </script>

    <script>
      // Dark mode
      document.getElementById("darkToggle").addEventListener("click", function () {
        document.documentElement.classList.toggle("dark");
      });

      // User dropdown
      function toggleUser(e) {
        e.stopPropagation();
        document.getElementById("user-panel").classList.toggle("open");
      }

      // Close on outside click
      document.addEventListener("click", function () {
        document.getElementById("user-panel").classList.remove("open");
      });

      // Language toggle
      function setLang(lang) {
        const en = document.getElementById("lang-en");
        const th = document.getElementById("lang-th");
        if (lang === "en") {
          en.classList.add("bg-primary", "text-white");
          en.classList.remove("text-slate-400", "dark:text-slate-500");
          th.classList.remove("bg-primary", "text-white");
          th.classList.add("text-slate-400");
        } else {
          th.classList.add("bg-primary", "text-white");
          th.classList.remove("text-slate-400", "dark:text-slate-500");
          en.classList.remove("bg-primary", "text-white");
          en.classList.add("text-slate-400");
        }
      }
    </script>
  </body>
</html>
